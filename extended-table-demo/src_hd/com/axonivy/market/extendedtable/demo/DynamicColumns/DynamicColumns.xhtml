<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:f="http://xmlns.jcp.org/jsf/core"
	xmlns:h="http://xmlns.jcp.org/jsf/html"
	xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
	xmlns:ic="http://ivyteam.ch/jsf/component"
	xmlns:p="http://primefaces.org/ui"
	xmlns:pe="http://primefaces.org/ui/extensions"
	xmlns:c="http://xmlns.jcp.org/jsp/jstl/core">
<h:body>
	<ui:composition template="/layouts/frame-10-full-width.xhtml">
		<ui:define name="title">Extended Table Showcase</ui:define>
		<ui:define name="content">

			<h2>Dynamic Columns</h2>
			<h:form id="dynamicColumnsForm">
				<p:messages />
				<ic:com.axonivy.market.extendedtable.ExtendedTable
					tableId="dynamicColumnsTable" widgetVar="dynamicColumnsTable"
					id="extendedTable" value="#{data.bean.items}" paginator="true"
					rows="10" scrollable="true" scrollWidth="100%"
					filteredValue="#{data.bean.filteredItems}">

					<f:facet name="header">
						<div class="p-d-flex p-jc-between p-ai-center" style="width: 100%">
							<span>Columns</span>
							<div
								style="display: inline-flex; gap: 10px; align-items: center;">
								<p:selectCheckboxMenu id="columnSelector"
									value="#{data.bean.selectedColumnProperties}"
									label="Select Columns" filter="true" filterMatchMode="contains"
									panelStyle="width:250px" scrollHeight="400">
									<f:selectItems value="#{data.bean.allColumnOptions}" var="opt"
										itemLabel="#{opt.label}" itemValue="#{opt.value}" />
								</p:selectCheckboxMenu>
								<p:commandButton value="Apply" icon="pi pi-check"
									action="#{data.bean.onColumnSelectionChange}"
									update=":dynamicColumnsForm:extendedTable:dynamicColumnsTable"
									styleClass="ui-button-success" />
							</div>
						</div>
					</f:facet>
					<!-- remote command to send visible columns CSV to backing bean -->
					<p:remoteCommand name="updateVisibleColumns"
						action="#{data.bean.updateVisibleColumns}" />

					<!-- render dynamic columns from bean.dynamicColumns; bean controls visibility -->
					<!-- Using c:forEach with c:if for build-time rendering with stable column IDs -->
					<c:forEach items="#{data.bean.dynamicColumns}" var="col">
						
						<!-- TEXT columns -->
						<c:if test="#{col.filterType == 'TEXT' and data.bean.isColumnVisible(col.property)}">
							<p:column id="#{col.property}" headerText="#{col.header}"
								filterBy="#{item[col.property]}"
								sortBy="#{item[col.property]}"
								filterMatchMode="contains"
								field="#{col.property}">
								<f:facet name="filter">
									<p:inputText onchange="filterTable()" 
										placeholder="Search..."
										style="width:100%" />
								</f:facet>
								<h:outputText value="#{item[col.property]}" />
							</p:column>
						</c:if>
						
						<!-- NUMBER columns with range filter -->
						<c:if test="#{col.filterType == 'NUMBER' and data.bean.isColumnVisible(col.property)}">
							<p:column id="#{col.property}" headerText="#{col.header}"
								filterBy="#{item[col.property]}"
								sortBy="#{item[col.property]}"
								filterMatchMode="custom"
								filterFunction="#{data.bean.filterNumber}"
								field="#{col.property}">
								<f:facet name="filter">
									<p:inputText id="#{col.property}Filter"
										placeholder="e.g: 4..6, ..10, 5.., or 5"
										onchange="filterTable()"
										style="width:100%" />
								</f:facet>
								<h:outputText value="#{item[col.property]}" />
							</p:column>
						</c:if>
						
						<!-- ENUM columns with multi-select -->
						<c:if test="#{col.filterType == 'ENUM' and data.bean.isColumnVisible(col.property)}">
							<p:column id="#{col.property}" headerText="#{col.header}"
								filterBy="#{item[col.property]}"
								sortBy="#{item[col.property]}"
								filterMatchMode="custom"
								filterFunction="#{data.bean.filterEnum}"
								field="#{col.property}">
								<f:facet name="filter">
									<p:selectCheckboxMenu 
										value="#{data.bean.enumFilters[col.property]}"
										onchange="filterTable()"
										multiple="true"
										style="width:100%; box-sizing: border-box;">
										<f:selectItems value="#{data.bean.getEnumOptions(col.property)}"
											var="opt"
											itemLabel="#{opt.label}"
											itemValue="#{opt.value}" />
									</p:selectCheckboxMenu>
								</f:facet>
								<h:outputText value="#{item[col.property]}" />
							</p:column>
						</c:if>
						
						<!-- BOOLEAN columns -->
						<c:if test="#{col.filterType == 'BOOLEAN' and data.bean.isColumnVisible(col.property)}">
							<p:column id="#{col.property}" headerText="#{col.header}"
								filterBy="#{item[col.property]}"
								sortBy="#{item[col.property]}"
								field="#{col.property}">
								<f:facet name="filter">
									<p:selectOneMenu onchange="filterTable()"
										style="width:100%; box-sizing: border-box;">
										<f:selectItem itemLabel="All" itemValue="#{null}" noSelectionOption="true" />
										<f:selectItem itemLabel="Yes" itemValue="true" />
										<f:selectItem itemLabel="No" itemValue="false" />
									</p:selectOneMenu>
								</f:facet>
								<h:outputText value="#{item[col.property] ? 'Yes' : 'No'}" />
							</p:column>
						</c:if>
						
						<!-- DATE columns with range filter -->
						<c:if test="#{col.filterType == 'DATE' and data.bean.isColumnVisible(col.property)}">
							<p:column id="#{col.property}" headerText="#{col.header}"
								filterBy="#{item[col.property]}"
								sortBy="#{item[col.property]}"
								filterMatchMode="custom"
								filterFunction="#{data.bean.filterDate}"
								field="#{col.property}">
								<f:facet name="filter">
									<p:datePicker 
										value="#{data.bean.dateFilters[col.property]}"
										selectionMode="range"
										pattern="yyyy-MM-dd"
										onchange="filterTable()"
										showIcon="true"
										showButtonBar="true"
										style="width:100%" />
								</f:facet>
								<h:outputText value="#{item[col.property]}" />
							</p:column>
						</c:if>
						
						<!-- DATETIME columns with range filter -->
						<c:if test="#{col.filterType == 'DATETIME' and data.bean.isColumnVisible(col.property)}">
							<p:column id="#{col.property}" headerText="#{col.header}"
								filterBy="#{item[col.property]}"
								sortBy="#{item[col.property]}"
								filterMatchMode="custom"
								filterFunction="#{data.bean.filterDateTime}"
								field="#{col.property}">
								<f:facet name="filter">
									<p:datePicker 
										value="#{data.bean.dateTimeFilters[col.property]}"
										selectionMode="range"
										pattern="yyyy-MM-dd HH:mm"
										showTime="true"
										onchange="filterTable()"
										showIcon="true"
										showButtonBar="true"
										style="width:100%" />
								</f:facet>
								<h:outputText value="#{item[col.property]}" />
							</p:column>
						</c:if>
						
						<!-- OBJECT columns (e.g., Country, Group) -->
						<c:if test="#{col.filterType == 'OBJECT' and data.bean.isColumnVisible(col.property)}">
							<p:column id="#{col.property}" headerText="#{col.header}"
								filterBy="#{item[col.property]}"
								sortBy="#{item[col.property]}"
								filterMatchMode="contains"
								field="#{col.property}">
								<f:facet name="filter">
									<p:inputText onchange="filterTable()"
										placeholder="Search..."
										style="width:100%" />
								</f:facet>
								<h:outputText value="#{item[col.property]}" />
							</p:column>
						</c:if>
						
					</c:forEach>				</ic:com.axonivy.market.extendedtable.ExtendedTable>

<!-- 				<script type="text/javascript">
					/*<![CDATA[*/
					function filterTable() {
						PF('dynamicColumnsTable').filter();
					}
					/*]]>*/
				</script> -->
			</h:form>
			
						<script>
				function filterTable() {
					PF('dynamicColumnsTable').filter();
				}
			</script>
		</ui:define>
	</ui:composition>
</h:body>

</html>